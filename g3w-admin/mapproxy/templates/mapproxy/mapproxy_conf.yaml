# #####################################################################
#                 MapProxy configuration
# #####################################################################
#

services:
  demo:
  wms:

    # only offer WMS 1.1.1
    versions: ['1.1.1', '1.3.0']

    # supported SRS for this WMS
    srs: {{supported_srs|safe}}

    # force the layer extents (BBOX) to be displayed in this SRS
    bbox_srs: ['EPSG:4326']

    # limit the supported image formats.
    image_formats: ['image/jpeg', 'image/png', 'image/gif', 'image/GeoTIFF']

    # return an OGC service exception when one or more sources return errors
    # or no response at all (e.g. timeout)
    on_source_errors: raise

    # some WMS clients do not send all required parameters in feature info
    # requests, MapProxy ignores these errors unless you set strict to true.
    strict: true

    # list of feature info types the server should offer
    featureinfo_types: ['text', 'html', 'xml', 'json']

    md:
      # metadata used in capabilities documents
      title: '{{title}}'
      abstract: '{{abstract}}'
  tms:
    use_grid_names: true
  wmts:
    restful: true
    restful_template: '/{Layer}/{TileMatrixSet}/{TileMatrix}/{TileCol}/{TileRow}.{Format}'
    kvp: true
  kml:
    use_grid_names: true

globals:
  cache:
    meta_size: [6, 6]
    meta_buffer: 20
    lock_dir: './locks_{{layer.pk}}'
    # where to store lockfiles for tile creation
    tile_lock_dir: './tile_locks_{{layer.pk}}'
    link_single_color_images: true
  http:
    ssl_no_cert_checks: true


grids:

{% if has_localgrid %}
  localgrid:
    srs: '{{srs}}'
    bbox: [{{bbox_4326}}]
    bbox_srs: 'EPSG:4326'
{% endif %}


###################################################################################
# Layers and caches


layers:

  - name: {{layer.name}}
    title: {{layer.title}}
    sources: [{{layer.name}}_{{layer.pk}}_cache]


caches:

  {{layer.name}}_{{layer.pk}}_cache:
    sources: [{{layer.name}}_{{layer.pk}}_wms]
    grids: [{% if has_localgrid %}localgrid, {% endif %}GLOBAL_GEODETIC, GLOBAL_MERCATOR, GLOBAL_WEBMERCATOR]
    concurrent_tile_creators: 2
    cache:
      type: file

sources:

  {{layer.name}}_{{layer.pk}}_wms:
    type: wms
    wms_opts:
      version: 1.3.0
      featureinfo: True
    req:
      url: {{ows_url}}
      layers: {{layer.name}}
      transparent: true
    supported_formats: [png,jpeg,tiff]
    coverage:
      bbox: [{{bbox_4326}}]
      srs: 'EPSG:4326'
